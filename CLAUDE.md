# Development Guidelines for Claude

このドキュメントは、Claude（AI開発アシスタント）がこのプロジェクトで作業する際に従うべきルールとガイドラインを定義します。

## 必須ルール

### 1. プッシュ前のE2Eテスト実行

**重要**: gitへのプッシュ前に必ずE2Eテストを実行してください。

```bash
# プッシュ前に必ず実行
./test/e2e.sh
```

**手順**:
1. コードの変更を完了
2. `./test/e2e.sh` を実行
3. すべてのテストがパスすることを確認
4. テストがパスした場合のみ `git push` を実行

**テストが失敗した場合**:
- 失敗原因を調査して修正
- 再度テストを実行
- すべてのテストがパスするまでプッシュしない

### 2. 新機能実装時のE2Eテスト追加

**重要**: 新機能を実装したら、ユーザーからの指示がなくても自動的にE2Eテストを追加してください。

**対象となる変更**:
- 新しいツール（Tool）の追加
- 新しいリソース（Resource）の追加
- 新しいプロンプト（Prompt）の追加
- 新しいAPIエンドポイントの追加
- 既存機能の重要な変更

**E2Eテスト追加の手順**:
1. 新機能の実装を完了
2. `test/e2e.sh` に対応するテストケースを追加
3. テストが正常に動作することを確認
4. テストの説明をコミットメッセージに含める

**テストケースの書き方**:
```bash
# Test N: 機能の説明
log_test "Test N: 機能の説明"
response=$(mcp_request "method/name" '{
    "param": "value"
}' N | extract_result)

if echo "$response" | jq -e '.result.expected_field' > /dev/null; then
    log_info "✓ テスト名 passed"
else
    log_error "✗ テスト名 failed"
    echo "Response: $response"
    TEST_FAILED=1
fi
```

### 3. テストファーストの開発

新機能を実装する際は、以下の順序で作業してください：

1. **テストケースの設計**: どのようなテストが必要かを先に考える
2. **機能の実装**: 実際の機能を実装
3. **テストの実装**: E2Eテストを追加
4. **テストの実行**: すべてのテストがパスすることを確認
5. **コミット・プッシュ**: テストがパスした後にプッシュ

## 開発ワークフロー

### 通常の変更

```bash
# 1. 機能実装
# コードを編集...

# 2. E2Eテスト追加（新機能の場合）
# test/e2e.sh を編集...

# 3. テスト実行
./test/e2e.sh

# 4. すべてパスしたらコミット
git add .
git commit -m "feat: 新機能の説明

- 機能の詳細
- E2Eテスト追加
"

# 5. プッシュ
git push
```

### バグ修正

```bash
# 1. バグの再現テストを追加
# test/e2e.sh に失敗するテストを追加

# 2. バグ修正
# コードを編集...

# 3. テスト実行（修正したテストがパスすることを確認）
./test/e2e.sh

# 4. コミット・プッシュ
git add .
git commit -m "fix: バグの説明

- 修正内容
- 再現テスト追加
"
git push
```

## テストに関する注意事項

### Streamable HTTP vs SSE

- **Streamable HTTP** (`/mcp`): ステートレス。各リクエストが独立
- **SSE** (`/sse`): セッションベース。状態を保持

テストの種類に応じて適切なエンドポイントを選択してください。

### テストのカバレッジ

すべてのテストは以下をカバーする必要があります：

- ✅ **正常系**: 期待通りの動作を確認
- ✅ **異常系**: エラーハンドリングを確認
- ✅ **境界値**: エッジケースを確認

### テストの独立性

各テストケースは独立して実行可能である必要があります：

- 前のテストの結果に依存しない
- テスト実行順序に依存しない
- クリーンな状態で実行できる

## コミットメッセージ

テストに関する変更を含む場合、コミットメッセージに明記してください：

```
feat: Add user authentication tool

- Implement login/logout tools
- Add session management
- Add E2E tests for authentication flow
  - ✓ Login with valid credentials
  - ✓ Login with invalid credentials
  - ✓ Logout and session cleanup
```

## 例外事項

以下の場合は、E2Eテストの追加を省略できます：

- ドキュメントのみの変更
- コメントのみの変更
- リファクタリング（動作変更なし）
- 内部実装の変更（外部APIに影響なし）

ただし、**プッシュ前のE2Eテスト実行は必須**です。

## チェックリスト

プッシュ前に以下を確認してください：

- [ ] E2Eテストを実行した (`./test/e2e.sh`)
- [ ] すべてのテストがパスした
- [ ] 新機能を追加した場合、対応するE2Eテストを追加した
- [ ] テストの追加/変更をコミットメッセージに記載した
- [ ] コードの品質を確認した（フォーマット、エラーハンドリングなど）

## まとめ

**重要な2つのルール**:

1. 🚨 **プッシュ前に必ず `./test/e2e.sh` を実行**
2. 🚨 **新機能実装時は必ずE2Eテストを追加**

これらのルールを守ることで、コードの品質を保ち、リグレッションを防ぐことができます。
